# Исправление экспорта данных для множественных селекторов

## Проблема

При выборе нескольких элементов на странице:
- ✅ В предварительном просмотре отображалось правильное количество колонок
- ❌ При экспорте данные экспортировались только с одним полем `value`

**Пример неправильного экспорта:**
```json
{
  "index": 1,
  "value": "4 106 ₽"
}
```

Вместо ожидаемого:
```json
{
  "index": 1,
  "Название": "Товар 1",
  "Цена": "4 106 ₽",
  "Ссылка": "https://example.com/item1"
}
```

## Причина

Функции `handleExportCSV()` и `handleExportJSON()` всегда преобразовывали данные в простой формат `{index, value}`, независимо от количества выбранных селекторов.

## Решение

Исправлены функции экспорта для поддержки множественных колонок:

1. **Добавлен метод `getAllColumnKeys()`** - определяет все колонки из извлеченных данных
2. **Переименован метод `extractValueFromItem()` в `extractValueFromItemData()`** - для ясности
3. **Обновлены функции экспорта:**
   - Если колонок больше одной → экспорт с несколькими колонками
   - Если одна колонка → простой формат `{index, value}`
   - Правильное извлечение значений для каждой колонки (href > src > text)

## Изменения в коде

### popup.js

1. **Новый метод `getAllColumnKeys()`:**
```javascript
getAllColumnKeys() {
    const allKeys = new Set();
    this.scrapedData.forEach(item => {
        Object.keys(item).forEach(key => {
            if (item[key] && typeof item[key] === 'object') {
                if (item[key].text !== undefined || item[key].href !== undefined || item[key].src !== undefined) {
                    allKeys.add(key);
                }
            }
        });
    });
    return Array.from(allKeys);
}
```

2. **Обновлен метод `extractValueFromItemData()`:**
   - Переименован из `extractValueFromItem()`
   - Принимает объект данных напрямую

3. **Обновлены `handleExportCSV()` и `handleExportJSON()`:**
   - Определяют количество колонок
   - Экспортируют с несколькими колонками при множественных селекторах
   - Сохраняют простой формат для одного селектора

## Форматы экспорта

### Одиночный селектор

**JSON:**
```json
[
  { "index": 1, "value": "Значение 1" },
  { "index": 2, "value": "Значение 2" }
]
```

**CSV:**
```csv
index,value
1,"Значение 1"
2,"Значение 2"
```

### Множественные селекторы

**JSON:**
```json
[
  { "index": 1, "Колонка1": "Значение 1", "Колонка2": "Значение 2" },
  { "index": 2, "Колонка1": "Значение 3", "Колонка2": "Значение 4" }
]
```

**CSV:**
```csv
index,"Колонка1","Колонка2"
1,"Значение 1","Значение 2"
2,"Значение 3","Значение 4"
```

## Тестирование

### Тест 1: Одиночный селектор
1. Выбрать один элемент
2. Извлечь данные
3. Экспортировать CSV/JSON
4. ✅ Проверить, что формат `{index, value}`

### Тест 2: Множественные селекторы
1. Выбрать несколько элементов (например, название, цена, ссылка)
2. Извлечь данные
3. Экспортировать CSV/JSON
4. ✅ Проверить, что все колонки присутствуют в экспорте
5. ✅ Проверить, что значения соответствуют предварительному просмотру

### Тест 3: Смешанные типы данных
1. Выбрать элементы разных типов (текст, ссылка, изображение)
2. Извлечь данные
3. Экспортировать
4. ✅ Проверить, что правильные значения извлекаются (href для ссылок, src для изображений, text для текста)

## Статус

✅ **Исправлено**
- Экспорт CSV поддерживает множественные колонки
- Экспорт JSON поддерживает множественные колонки
- Сохранена обратная совместимость с одиночным селектором
- Значения правильно извлекаются для каждого типа данных

---

**Дата исправления:** 16.12.2025
**Файлы изменены:** `Dataminer/extension/popup.js`

