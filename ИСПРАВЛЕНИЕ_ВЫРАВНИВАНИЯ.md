# Исправление проблемы выравнивания данных

## Проблема

При извлечении данных с множественными селекторами, если селекторы находят разное количество элементов:
- Элементы с индексами, где один селектор не находит элемент, имеют пустые значения
- Поля для отсутствующих элементов не добавляются в результат
- Это приводит к неправильному экспорту данных

**Пример проблемы:**
```json
{
  "index": 25,
  "cell-list__item-title": "",  // Пусто, потому что элемент не найден
  "cell-info__date": "08:00"    // Заполнено
}
```

## Причина

1. **Выравнивание по максимальной длине:** Код использует `Math.max()` для определения количества элементов
2. **Условное добавление полей:** Поля добавлялись только если значение не пустое (строка 278)
3. **Отсутствие обработки отсутствующих элементов:** Если элемент не найден по индексу, поле не добавлялось

## Решение

### Изменения в ScrapingService.js

1. **Всегда добавлять поля:**
   - Поле добавляется для каждого селектора, даже если элемент не найден
   - Пустые значения явно устанавливаются как пустые строки

2. **Добавлена валидация:**
   - Проверка разницы в количестве элементов между селекторами
   - Предупреждение в консоль, если разница > 20%

3. **Улучшена логика добавления элементов:**
   - Элемент добавляется, если хотя бы одно значение заполнено
   - Элемент также добавляется, если все поля присутствуют (даже пустые)

## Код изменений

### До:
```javascript
if (visibleElements[i]) {
    const value = extractValue(el, dataType);
    if (value && value.trim() !== '') {
        item[selector.name] = { ... };
    }
}
// Поле не добавлялось, если значение пустое или элемент не найден
```

### После:
```javascript
// Проверка разницы в количестве элементов
const mismatchPercentage = ((maxCount - minCount) / maxCount) * 100;
if (mismatchPercentage > 20) {
    console.log(`⚠️ Warning: Selectors found different number of elements...`);
}

// Всегда добавляем поле
if (visibleElements[i]) {
    const value = extractValue(el, dataType);
    item[selector.name] = {
        text: dataType === 'textContent' ? (value || '') : '',
        href: dataType === 'href' ? (value || '') : '',
        src: dataType === 'src' ? (value || '') : ''
    };
} else {
    // Элемент не найден - добавляем пустое поле
    item[selector.name] = {
        text: '',
        href: '',
        src: ''
    };
}
```

## Результат

После исправления:
- ✅ Все элементы имеют поля для всех селекторов
- ✅ Пустые значения явно установлены как пустые строки
- ✅ В консоли появляется предупреждение при большом расхождении
- ✅ Экспорт содержит все поля, даже если значения пустые

## Тестирование

### Тест 1: Селекторы с разным количеством элементов
1. Выбрать два селектора, которые находят разное количество элементов
2. Извлечь данные
3. ✅ Проверить, что все элементы имеют оба поля
4. ✅ Проверить консоль на наличие предупреждения

### Тест 2: Пустые значения
1. Выбрать селекторы, где некоторые элементы не имеют значений
2. Извлечь данные
3. ✅ Проверить, что пустые значения экспортируются как `""`
4. ✅ Проверить, что структура данных правильная

### Тест 3: Экспорт
1. Извлечь данные с пустыми значениями
2. Экспортировать в JSON/CSV
3. ✅ Проверить, что все поля присутствуют
4. ✅ Проверить, что пустые значения правильно обработаны

---

**Статус:** ✅ Исправлено
**Дата:** 16.12.2025
**Файлы:** `Dataminer/extension/services/ScrapingService.js`

