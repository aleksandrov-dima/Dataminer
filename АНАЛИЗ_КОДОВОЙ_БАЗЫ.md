# Анализ кодовой базы OnPage-Scraper для упрощения до Dataminer

## Структура проекта

### Backend (удалить полностью)
- `backend/` - Node.js сервер с Express, MongoDB, Passport
  - Авторизация (JWT, bcrypt)
  - API для сохранения отчетов
  - Модели: User, Report, ReportChunk
  - Зависимости: express, mongoose, passport, jsonwebtoken, bcryptjs

### Extension (основная часть)
- `extension/` - Chrome Extension (Manifest V3)
  - `manifest.json` - конфигурация расширения
  - `popup.html/js/css` - интерфейс popup
  - `content.js/css` - скрипт для работы со страницей
  - `background.js` - service worker
  - `reports.html/js/css` - страница отчетов
  - `services/` - сервисы:
    - `AuthService.js` - авторизация (удалить)
    - `ReportService.js` - работа с отчетами через API (удалить)
    - `ScrapingService.js` - извлечение данных (сохранить, упростить)
    - `ToastService.js` - уведомления (сохранить)
  - `utils/` - утилиты:
    - `CSVUtils.js` - экспорт в CSV (сохранить)
    - `JSONUtils.js` - экспорт в JSON (сохранить)

---

## Карта функциональности

### Компоненты UI

#### Popup (popup.html)
1. **Авторизация** (удалить):
   - Форма входа (`#loginForm`)
   - Форма регистрации (`#registerForm`)
   - Переключение между формами

2. **Dashboard** (упростить):
   - Приветствие пользователя (удалить)
   - Кнопка настроек (удалить)
   - Кнопка выхода (удалить)
   - Прогресс сканирования (удалить)
   - Карточка результатов сканирования (удалить)
   - Workflow шаги (удалить)

3. **Select & Extract Page** (упростить):
   - Кнопка "Select Elements" (сохранить)
   - Список выбранных элементов (сохранить)
   - Ручной ввод селекторов (удалить)
   - Примеры селекторов (удалить)
   - Container selector (удалить)
   - Опции извлечения (упростить - оставить только базовые)
   - Кнопка "Start Extraction" (сохранить)
   - Прогресс извлечения (сохранить)
   - Карточка завершения (упростить)

4. **Settings Page** (удалить полностью):
   - Настройки chunk size
   - Auto-save
   - Уведомления

5. **Reports Page** (удалить полностью):
   - Отдельная страница reports.html
   - Список сохраненных отчетов
   - Просмотр отчетов

### Функции/Сервисы

#### AuthService.js (удалить полностью)
- `login()` - вход
- `register()` - регистрация
- `logout()` - выход
- `getToken()` - получение токена
- `getUser()` - получение пользователя
- `isAuthenticated()` - проверка авторизации
- `verifyToken()` - проверка токена
- `updatePreferences()` - обновление настроек

#### ReportService.js (удалить полностью)
- `createReport()` - создание отчета
- `createReportChunk()` - создание чанка отчета
- `appendReportChunk()` - добавление чанка
- `getReports()` - получение отчетов
- `getReport()` - получение отчета
- `deleteReport()` - удаление отчета
- Все методы работают через API к backend

#### ScrapingService.js (сохранить, упростить)
- `startScraping()` - запуск извлечения (сохранить, упростить)
- `stopScraping()` - остановка извлечения (сохранить)
- `getScrapedData()` - получение данных (сохранить)
- `scrapePageFunction()` - функция извлечения (упростить - убрать auto-scroll, infinite scroll)

#### ToastService.js (сохранить)
- Все методы уведомлений (сохранить)

#### CSVUtils.js (сохранить)
- Экспорт в CSV (сохранить)

#### JSONUtils.js (сохранить)
- Экспорт в JSON (сохранить)

### Content Script (content.js)
- Визуальный выбор элементов (сохранить):
  - `startElementSelection()` - режим выбора
  - `highlightElement()` - подсветка при наведении
  - `selectElement()` - выбор элемента
  - `generateSelector()` - генерация селектора (сохранить)
  - `generateElementName()` - генерация имени (сохранить)
- UI для выбора (сохранить):
  - Overlay
  - Инструкции
  - Кнопки Finish/Cancel

### Background Script (background.js)
- Обработка сообщений (упростить):
  - `handleScrapedData()` - сохранить
  - `handleScrapingComplete()` - сохранить
  - `handleElementsSelected()` - сохранить
  - Удалить обработку авторизации и отчетов

---

## Компоненты для удаления

### 1. Авторизация и аутентификация
- ✅ `extension/services/AuthService.js` - полностью
- ✅ Формы входа/регистрации в `popup.html`
- ✅ Проверки авторизации в `popup.js`
- ✅ JWT токены и их хранение
- ✅ API вызовы к `/auth/*`

### 2. Облачное хранение данных
- ✅ `extension/services/ReportService.js` - полностью
- ✅ `extension/reports.html/js/css` - полностью
- ✅ API вызовы к `/reports/*`
- ✅ Chunked upload логика
- ✅ Синхронизация с localStorage

### 3. Серверная часть (backend)
- ✅ Вся папка `backend/` - полностью удалить
- ✅ Зависимости от backend в extension

### 4. Настройки и профили
- ✅ Страница Settings в `popup.html`
- ✅ `handleSettingsSave()` в `popup.js`
- ✅ `loadUserSettings()` в `popup.js`
- ✅ Хранение настроек пользователя

### 5. Сохранённые проекты
- ✅ Страница Reports
- ✅ Список сохраненных отчетов
- ✅ Просмотр отчетов
- ✅ Управление отчетами

### 6. История действий
- ✅ Workflow шаги
- ✅ История извлечений
- ✅ Логирование действий

### 7. Пагинация и infinite scroll
- ✅ Auto-scroll в `ScrapingService.js` (функция `scrollAndScrape`)
- ✅ Логика определения конца страницы
- ✅ Счетчики скроллинга

### 8. Сценарии и workflows
- ✅ Workflow UI в popup
- ✅ Шаги выполнения
- ✅ Навигация по шагам

### 9. AI-функции
- ✅ (Не обнаружено в текущей версии)

### 10. Дополнительные опции извлечения
- ✅ Container selector
- ✅ Deep scan (iframes/shadow DOM)
- ✅ Structured data extraction
- ✅ Ручной ввод селекторов
- ✅ Примеры селекторов

---

## Компоненты для сохранения

### 1. Визуальный выбор DOM-элементов (hover highlight)
- ✅ `content.js` - класс `OnPageContentScript`
- ✅ Методы `highlightElement()`, `selectElement()`
- ✅ Генерация селекторов `generateSelector()`
- ✅ UI для выбора (overlay, инструкции)
- ✅ CSS стили для подсветки

### 2. Извлечение данных из DOM
- ✅ `ScrapingService.js` - функция `scrapePageFunction()`
- ✅ Базовая логика извлечения:
  - Поиск элементов по селектору
  - Извлечение textContent
  - Извлечение href для ссылок
  - Извлечение src для изображений
- ⚠️ Упростить: убрать auto-scroll, container selector, deep scan

### 3. Формирование таблицы результатов
- ✅ Структура данных в `scrapedData`
- ✅ Отображение в popup (нужно упростить UI)
- ✅ Предпросмотр результатов

### 4. Экспорт данных
- ✅ `utils/CSVUtils.js` - экспорт в CSV
- ✅ `utils/JSONUtils.js` - экспорт в JSON
- ✅ Кнопки экспорта в popup

---

## Зависимости и связи между модулями

### Текущие зависимости

1. **popup.js** зависит от:
   - `AuthService` (удалить)
   - `ReportService` (удалить)
   - `ScrapingService` (сохранить)
   - `ToastService` (сохранить)

2. **ScrapingService.js** зависит от:
   - Chrome APIs (сохранить)
   - content.js (сохранить)

3. **content.js**:
   - Независимый модуль (сохранить)
   - Общается через chrome.runtime.sendMessage

4. **background.js**:
   - Обрабатывает сообщения (упростить)
   - Хранит временные данные (сохранить)

### После упрощения

1. **popup.js** будет зависеть только от:
   - `ScrapingService`
   - `ToastService`
   - `CSVUtils`
   - `JSONUtils`

2. **ScrapingService.js**:
   - Упрощенная версия без auto-scroll
   - Прямое извлечение данных

3. **content.js**:
   - Без изменений

4. **background.js**:
   - Только обработка сообщений о данных

---

## План упрощения UI

### Новый минималистичный popup

1. **Кнопка "Select element"** - запускает режим выбора
2. **Список выбранных элементов** - показывает выбранные селекторы
3. **Кнопка "Extract data"** - активна только после выбора элемента
4. **Область предпросмотра таблицы** - показывает результаты
5. **Кнопки экспорта**:
   - "Export CSV"
   - "Export JSON"

### Удалить из UI:
- Все формы авторизации
- Dashboard с приветствием
- Настройки
- Workflow шаги
- Container selector
- Ручной ввод селекторов
- Примеры селекторов
- Сложные опции извлечения
- Страницу Reports

---

## Следующие шаги

1. ✅ Клонировать репозиторий
2. ✅ Создать ветку разработки
3. ✅ Составить карту функциональности
4. ⏭️ Начать удаление компонентов (Этап 2)

